name: Mirror Parity PRs

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *' # hourly

permissions:
  contents: write  # enough to push PR branches safely

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup logging
        run: |
          echo "üü£ Starting mirror process at $(date)"
          echo "Git version: $(git --version)"
          echo "GH CLI version: $(gh --version || echo 'not installed')"
          echo "Current repository: $GITHUB_REPOSITORY"

      - name: Install GitHub CLI and jq
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y gh jq

      - name: Authenticate GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîë Using built-in GH_TOKEN"
          gh auth status || echo "‚ö†Ô∏è Could not verify auth status"

      - name: Mirror top 10 safe PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          echo "üîÑ Adding upstream remote..."
          git remote remove upstream 2>/dev/null || true
          git remote add upstream https://github.com/paritytech/polkadot-sdk.git

          echo "üîé Fetching recent PRs..."
          # Fetch 50 recent PRs to ensure we get enough safe ones
          all_prs=$(gh pr list -R paritytech/polkadot-sdk --state open --limit 50 --json number --jq '.[].number')

          prs_to_mirror=""
          count=0
          max=10

          for pr in $all_prs; do
            # Check if PR touches workflow files
            files=$(gh pr view $pr --repo paritytech/polkadot-sdk --json files --jq '.files[].path')
            if echo "$files" | grep -q "^\.github/workflows/"; then
              echo "‚ö†Ô∏è Skipping PR #$pr (workflow file)"
              continue
            fi

            # Add safe PR to mirror list
            prs_to_mirror="$prs_to_mirror $pr"
            count=$((count + 1))
            if [ $count -ge $max ]; then
              break
            fi
          done

          if [ -z "$prs_to_mirror" ]; then
            echo "‚ÑπÔ∏è No safe PRs found to mirror."
            exit 0
          fi

          echo "üß© Mirroring PRs: $prs_to_mirror"

          for pr in $prs_to_mirror; do
            echo "‚û°Ô∏è Processing PR #$pr"
            if git fetch upstream pull/$pr/head:pr-$pr --depth=1; then
              echo "‚úÖ Fetched PR #$pr"
              git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository_owner }}/polkadot-sdk.git" pr-$pr --force
              echo "‚òëÔ∏è Mirrored PR #$pr successfully."
            else
              echo "‚ö†Ô∏è Failed to fetch PR #$pr"
            fi
          done

          echo "‚úÖ Mirroring complete at $(date)."
