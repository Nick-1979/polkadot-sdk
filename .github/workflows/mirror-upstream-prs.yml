name: Mirror Parity PRs

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *' # every hour

# Global permissions ‚Äî critical for allowing workflow file updates
permissions:
  contents: write
  workflows: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup logging and environment
        run: |
          echo "üü£ Starting mirror process at $(date)"
          echo "Git version: $(git --version)"
          echo "GH CLI version: $(gh --version || echo 'not installed')"
          echo "Current repository: $GITHUB_REPOSITORY"

      - name: Install GitHub CLI and jq
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y gh jq

      - name: Authenticate GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîë Using runner's built-in GH_TOKEN for authentication"
          gh auth status || echo "‚ö†Ô∏è Could not verify auth status, continuing anyway."

      - name: Mirror top 10 Parity PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          echo "üîÑ Adding upstream remote..."
          git remote remove upstream 2>/dev/null || true
          git remote add upstream https://github.com/paritytech/polkadot-sdk.git

          echo "üîé Getting list of open PRs (limit 10)..."
          prs=$(gh pr list -R paritytech/polkadot-sdk --state open --limit 10 --json number --jq '.[].number') || {
            echo "‚ùå Failed to get PR list. Check authentication or API limits."
            exit 1
          }

          if [ -z "$prs" ]; then
            echo "‚ÑπÔ∏è No open PRs found to mirror."
            exit 0
          fi

          echo "üß© Mirroring PRs: $prs"
          for pr in $prs; do
            echo "‚û°Ô∏è  Fetching PR #$pr"
            if git fetch upstream pull/$pr/head:pr-$pr --depth=1; then
              echo "‚úÖ Fetched PR #$pr"
              git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository_owner }}/polkadot-sdk.git" pr-$pr --force || true
              echo "‚òëÔ∏è  Mirrored PR #$pr successfully."
            else
              echo "‚ö†Ô∏è  Failed to fetch PR #$pr (maybe large or removed)."
            fi
          done

          echo "‚úÖ Mirroring complete at $(date)."
